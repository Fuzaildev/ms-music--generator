/*! For license information please see 454945697dbdb60cd5a3.js.LICENSE.txt */
function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function u(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,n){return e[t]=n}}function l(e,t,n,r){var a=t&&t.prototype instanceof y?t:y,i=Object.create(a.prototype),s=new A(r||[]);return o(i,"_invoke",{value:S(e,n,s)}),i}function h(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=l;var d="suspendedStart",p="suspendedYield",f="executing",g="completed",m={};function y(){}function w(){}function v(){}var k={};u(k,i,(function(){return this}));var b=Object.getPrototypeOf,_=b&&b(b(P([])));_&&_!==n&&r.call(_,i)&&(k=_);var x=v.prototype=y.prototype=Object.create(k);function E(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function I(e,t){function n(o,a,i,s){var c=h(e[o],e,a);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==_typeof(l)&&r.call(l,"__await")?t.resolve(l.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(l).then((function(e){u.value=e,i(u)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return a=a?a.then(o,o):o()}})}function S(t,n,r){var o=d;return function(a,i){if(o===f)throw Error("Generator is already running");if(o===g){if("throw"===a)throw i;return{value:e,done:!0}}for(r.method=a,r.arg=i;;){var s=r.delegate;if(s){var c=C(s,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===d)throw o=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var u=h(t,n,r);if("normal"===u.type){if(o=r.done?g:p,u.arg===m)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(o=g,r.method="throw",r.arg=u.arg)}}}function C(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,C(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var a=h(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,m;var i=a.arg;return i?i.done?(n[t.resultName]=i.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function L(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(L,this),this.reset(!0)}function P(t){if(t||""===t){var n=t[i];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(_typeof(t)+" is not iterable")}return w.prototype=v,o(x,"constructor",{value:v,configurable:!0}),o(v,"constructor",{value:w,configurable:!0}),w.displayName=u(v,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,u(e,c,"GeneratorFunction")),e.prototype=Object.create(x),e},t.awrap=function(e){return{__await:e}},E(I.prototype),u(I.prototype,s,(function(){return this})),t.AsyncIterator=I,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var i=new I(l(e,n,r,o),a);return t.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},E(x),u(x,c,"Generator"),u(x,i,(function(){return this})),u(x,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=P,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(T),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=r.call(i,"catchLoc"),u=r.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,m):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),T(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;T(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:P(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function asyncGeneratorStep(e,t,n,r,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){asyncGeneratorStep(a,r,o,i,s,"next",e)}function s(e){asyncGeneratorStep(a,r,o,i,s,"throw",e)}i(void 0)}))}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var OfficeAuthManager=function(){return _createClass((function e(){_classCallCheck(this,e),this.clientId="HGn3aX2z6aOFhikeyc2MXLcrEdxw6apkZo2W0MiW",this.redirectUri="https://multiplewords.com/oauth/office/callback/",this.authEndpoint="https://multiplewords.com/oauth/office/authorize/",this.clientSecret="dknkj3ofK0Lh8mG5XrDNZSK7ldaYD2fI8bLBxCIqgXvrf4lMZyVAQhGqIIx3aIfFj4ZDeNazPfj9hmdhKBhmsU0slYCR2bR3t2C1uLv801ic4PxJOCnf28zdLoEjeWHg",this.tokenEndpoint="https://multiplewords.com/o/token/",this.dialog=null,this.state=null,this.platform=null,this.pollInterval=null,this.authWindow=null,this.pollDelay=0,this.maxAboutBlankAttempts=20,this.authCompleted=!1,this.isCancelled=!1,this.codeUsed=!1,console.log("🔐 OfficeAuthManager initialized with:",{clientId:this.clientId,redirectUri:this.redirectUri,authEndpoint:this.authEndpoint,tokenEndpoint:this.tokenEndpoint})}),[{key:"generateState",value:function(){var e=new Uint32Array(8);window.crypto.getRandomValues(e);var t=Array.from(e,(function(e){return("0"+e.toString(16)).substr(-2)})).join("");return console.log("🔑 Generated state parameter:",t),t}},{key:"detectPlatform",value:function(){var e="OfficeOnline"===Office.context.platform?"web":"desktop";return console.log("🌐 Detected platform:",e,"Office.context.platform:",Office.context.platform),e}},{key:"startAuthFlow",value:(i=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("🚀 Starting authentication flow"),this.platform=this.detectPlatform(),this.state=this.generateState(),sessionStorage.setItem("oauth_state",this.state),console.log("💾 Stored state in sessionStorage:",this.state),(t=new URL(this.authEndpoint)).searchParams.append("client_id",this.clientId),t.searchParams.append("redirect_uri",this.redirectUri),t.searchParams.append("response_type","code"),t.searchParams.append("state",this.state),t.searchParams.append("platform",this.platform),t.searchParams.append("scope","read write"),n=t.toString(),console.log("🔗 Constructed auth URL:",n),console.log("Using popup window authentication flow for ".concat(this.platform," platform")),e.abrupt("return",this.handlePopupAuth(n));case 16:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"handlePopupAuth",value:(a=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n=this;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Starting popup authentication with URL for ".concat(this.platform," platform:"),t),e.abrupt("return",new Promise((function(e,r){return n.isCancelled?(console.log("❌ Authentication cancelled by user"),void r(new Error("Authentication cancelled by user"))):(n.authCompleted=!1,console.log("🪟 Attempting to open popup window"),n.authWindow=window.open(t,"oauth","width=600,height=600"),n.authWindow?(console.log("✅ Popup window opened successfully"),void n.checkAuthCode(e,r)):(console.log("⚠️ Popup window was blocked by browser"),void n.showFallbackModal(t,e,r)))})));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"checkAuthCode",value:function(e,t){var n=this;console.log("🔄 Starting to check for auth code via API");var r=!1,o=function(){n.pollInterval&&(clearTimeout(n.pollInterval),n.pollInterval=null),n.authWindow&&!n.authWindow.closed&&n.authWindow.close(),n.authWindow=null},a=function(){var i=_asyncToGenerator(_regeneratorRuntime().mark((function i(){var s,c,u;return _regeneratorRuntime().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!r&&!n.authCompleted){i.next=3;break}return o(),i.abrupt("return");case 3:if(!n.isCancelled){i.next=8;break}return o(),"function"==typeof window.hideLoader&&window.hideLoader(),t(new Error("Authentication cancelled by user")),i.abrupt("return");case 8:return i.prev=8,i.next=11,fetch("https://multiplewords.com/oauth/office/code-by-state/?state=".concat(n.state),{cache:"no-store"});case 11:if(!(s=i.sent).ok){i.next=37;break}return i.next=15,s.json();case 15:if(!(c=i.sent).code||!c.state||r){i.next=37;break}if(c.state===n.state){i.next=21;break}return o(),t(new Error("State mismatch - possible CSRF attack")),i.abrupt("return");case 21:return"function"==typeof window.hideLoader&&window.hideLoader(),n.authCompleted=!0,r=!0,"function"==typeof window.showSuccess&&window.showSuccess("Authentication successful!"),o(),i.prev=26,i.next=29,n.exchangeCodeForToken(c.code);case 29:u=i.sent,e({code:c.code,state:c.state,token:u}),i.next=36;break;case 33:i.prev=33,i.t0=i.catch(26),t(i.t0);case 36:return i.abrupt("return");case 37:i.next=42;break;case 39:i.prev=39,i.t1=i.catch(8),console.error("Error checking auth code:",i.t1);case 42:if(!n.authWindow||!n.authWindow.closed||r){i.next=46;break}return o(),n.authCompleted||("function"==typeof window.hideLoader&&window.hideLoader(),t(new Error("Authentication window was closed"))),i.abrupt("return");case 46:r||n.isCancelled||(n.pollInterval=setTimeout(a,0));case 47:case"end":return i.stop()}}),i,null,[[8,39],[26,33]])})));return function(){return i.apply(this,arguments)}}();a()}},{key:"showFallbackModal",value:function(e,t,n){var r=this;console.log("🔄 Showing fallback modal for blocked popup");var o=document.createElement("div");if(o.className="auth-modal",o.innerHTML='\n            <div class="auth-modal-content">\n                <h3>Authentication Required</h3>\n                <p>Your browser blocked the authentication popup. Please follow these steps:</p>\n                <ol>\n                    <li>Click the link below to open the authentication page in a new tab</li>\n                    <li>Complete the authentication process</li>\n                    <li>Return to this window and click "I\'ve Completed Authentication"</li>\n                </ol>\n                <div class="auth-modal-actions">\n                    <a href="'.concat(e,'" target="_blank" class="ms-Button ms-Button--primary">\n                        <span class="ms-Button-label">Open Authentication Page</span>\n                    </a>\n                    <button id="auth-complete-btn" class="ms-Button ms-Button--primary">\n                        <span class="ms-Button-label">I\'ve Completed Authentication</span>\n                    </button>\n                    <button id="auth-cancel-btn" class="ms-Button ms-Button--danger">\n                        <span class="ms-Button-label">Cancel</span>\n                    </button>\n                </div>\n            </div>\n        '),!document.querySelector("style.auth-modal-style")){var a=document.createElement("style");a.className="auth-modal-style",a.textContent="\n                .auth-modal {\n                    position: fixed;\n                    top: 0;\n                    left: 0;\n                    right: 0;\n                    bottom: 0;\n                    background: rgba(0, 0, 0, 0.5);\n                    display: flex;\n                    justify-content: center;\n                    align-items: center;\n                    z-index: 9999;\n                }\n                .auth-modal-content {\n                    background: white;\n                    padding: 20px;\n                    border-radius: 4px;\n                    max-width: 500px;\n                    width: 90%;\n                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\n                }\n                .auth-modal h3 {\n                    margin-top: 0;\n                    color: #0078D4;\n                }\n                .auth-modal ol {\n                    margin-bottom: 20px;\n                }\n                .auth-modal-actions {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 10px;\n                }\n                .auth-modal-actions a, .auth-modal-actions button {\n                    width: 100%;\n                    text-align: center;\n                    text-decoration: none;\n                }\n            ",document.head.appendChild(a)}document.body.appendChild(o),document.getElementById("auth-complete-btn").onclick=function(){console.log("👆 User clicked 'I've Completed Authentication' button"),document.body.removeChild(o),r.checkAuthCode(t,n)},document.getElementById("auth-cancel-btn").onclick=function(){console.log("❌ User cancelled authentication via modal"),document.body.removeChild(o),n(new Error("Authentication cancelled by user"))}}},{key:"exchangeCodeForToken",value:(o=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o,a,i,s,c,u,l;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("🔄 Starting token exchange process"),!this.codeUsed){e.next=4;break}throw console.error("❌ Authorization code has already been used"),new Error("Authorization code has already been used - this is expected if you're already authenticated");case 4:return(n=new URLSearchParams).append("grant_type","authorization_code"),n.append("code",t),n.append("client_id",this.clientId),n.append("client_secret",this.clientSecret),n.append("redirect_uri",this.redirectUri),n.append("include_user_info","true"),e.prev=11,console.log("📡 Sending token request to:",this.tokenEndpoint),console.log("📤 Request data:",{grant_type:"authorization_code",code:t.substring(0,5)+"...",client_id:this.clientId,redirect_uri:this.redirectUri}),e.next=16,fetch(this.tokenEndpoint,{method:"POST",body:n,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"}});case 16:if(r=e.sent,console.log("📥 Token response status:",r.status),console.log("📥 Token response headers:",Object.fromEntries(r.headers.entries())),r.ok){e.next=31;break}return e.next=22,r.text();case 22:o=e.sent,console.error("❌ Token exchange failed with status:",r.status),console.error("❌ Error response:",o),console.error("❌ Request URL:",this.tokenEndpoint),console.error("❌ Request headers:",{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"}),console.error("❌ Request body (excluding code):",{grant_type:"authorization_code",client_id:this.clientId,redirect_uri:this.redirectUri,include_user_info:"true"}),a="Token exchange failed: ".concat(r.status," ").concat(r.statusText);try{(i=JSON.parse(o)).error&&(a+=" - ".concat(i.error),i.error_description&&(a+=": ".concat(i.error_description)))}catch(e){a+=" - ".concat(o)}throw new Error(a);case 31:return e.next=33,r.json();case 33:return s=e.sent,console.log("✅ Token exchange successful"),this.codeUsed=!0,e.prev=36,console.log("🔍 Getting user ID from check-canva-token endpoint"),e.next=40,fetch("https://multiplewords.com/oauth/check-canva-token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:new URLSearchParams({token:s.access_token})});case 40:if(c=e.sent,console.log("📥 Check-canva-token response status:",c.status),!c.ok){e.next=49;break}return e.next=45,c.json();case 45:(u=e.sent).user_id?(s.user_id=u.user_id,console.log("✅ User ID found from check-canva-token:",u.user_id)):console.warn("⚠️ No user ID found in check-canva-token response"),e.next=54;break;case 49:return e.next=51,c.text();case 51:l=e.sent,console.warn("⚠️ Failed to get user ID from check-canva-token:",c.status),console.warn("⚠️ Error response:",l);case 54:e.next=59;break;case 56:e.prev=56,e.t0=e.catch(36),console.warn("⚠️ Error fetching from check-canva-token:",e.t0);case 59:return e.next=61,this.storeTokens(s);case 61:return"function"==typeof window.showSuccess&&window.showSuccess("Authentication successful!"),e.abrupt("return",s);case 65:throw e.prev=65,e.t1=e.catch(11),console.error("❌ Token exchange failed:",e.t1),e.t1;case 69:case"end":return e.stop()}}),e,this,[[11,65],[36,56]])}))),function(e){return o.apply(this,arguments)})},{key:"storeTokens",value:(r=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,sessionStorage.setItem("access_token",t.access_token),sessionStorage.setItem("refresh_token",t.refresh_token),sessionStorage.setItem("token_expiry",Date.now()+1e3*t.expires_in),t.user_id?(sessionStorage.setItem("user_id",t.user_id),console.log("✅ User ID stored:",t.user_id)):console.warn("⚠️ No user ID available in token data"),console.log("✅ Tokens stored successfully"),"function"==typeof window.checkTokens&&window.checkTokens(),e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(0),console.error("❌ Error storing tokens:",e.t0),e.t0;case 13:case"end":return e.stop()}}),e,null,[[0,9]])}))),function(e){return r.apply(this,arguments)})},{key:"getUserId",value:function(){var e=sessionStorage.getItem("user_id");return e||console.warn("⚠️ No user ID found in session storage"),e}},{key:"isTokenExpired",value:function(){var e=!this.getUserId();return console.log("🔍 Authentication check: ".concat(e?"Not authenticated (no user ID)":"Authenticated")),e}},{key:"refreshToken",value:(n=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r,o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("🔄 Refreshing token"),t=sessionStorage.getItem("refresh_token")){e.next=5;break}throw console.error("❌ No refresh token available"),new Error("No refresh token available");case 5:return console.log("🔑 Using refresh token: ".concat(t.substring(0,10),"...")),(n=new URLSearchParams).append("grant_type","refresh_token"),n.append("refresh_token",t),n.append("client_id",this.clientId),console.log("📤 Refresh token request data:",{grant_type:"refresh_token",refresh_token:"".concat(t.substring(0,10),"..."),client_id:this.clientId}),e.prev=11,console.log("📡 Sending refresh token request to: ".concat(this.tokenEndpoint)),e.next=15,fetch(this.tokenEndpoint,{method:"POST",body:n,headers:{"Content-Type":"application/x-www-form-urlencoded"}});case 15:if(r=e.sent,console.log("📥 Refresh token response status: ".concat(r.status)),r.ok){e.next=20;break}throw console.error("❌ Token refresh failed"),new Error("Token refresh failed");case 20:return e.next=22,r.json();case 22:return o=e.sent,console.log("✅ Token refresh successful"),console.log("🔑 New token data:",{access_token:o.access_token?"".concat(o.access_token.substring(0,10),"..."):"undefined",refresh_token:o.refresh_token?"".concat(o.refresh_token.substring(0,10),"..."):"undefined",expires_in:o.expires_in,token_type:o.token_type}),this.storeTokens(o),e.abrupt("return",o);case 29:throw e.prev=29,e.t0=e.catch(11),console.error("❌ Error refreshing token:",e.t0),e.t0;case 33:case"end":return e.stop()}}),e,this,[[11,29]])}))),function(){return n.apply(this,arguments)})},{key:"authenticate",value:(t=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.isCancelled=!1,this.codeUsed=!1,e.next=5,this.startAuthFlow();case 5:if(t=e.sent,!this.isCancelled){e.next=8;break}return e.abrupt("return",{success:!1,error:"Authentication cancelled by user"});case 8:return e.prev=8,e.next=11,this.exchangeCodeForToken(t.code);case 11:return n=e.sent,"function"==typeof window.hideLoader&&window.hideLoader(),e.abrupt("return",{success:!0,token:n.access_token,userId:this.getUserId()});case 16:if(e.prev=16,e.t0=e.catch(8),!e.t0.message.includes("Authorization code has already been used")){e.next=22;break}if(this.isTokenExpired()){e.next=22;break}return"function"==typeof window.hideLoader&&window.hideLoader(),e.abrupt("return",{success:!0,token:sessionStorage.getItem("access_token"),userId:this.getUserId()});case 22:throw e.t0;case 23:e.next=30;break;case 25:return e.prev=25,e.t1=e.catch(0),console.error("❌ Authentication process failed:",e.t1),"function"==typeof window.hideLoader&&window.hideLoader(),e.abrupt("return",{success:!1,error:e.t1.message});case 30:case"end":return e.stop()}}),e,this,[[0,25],[8,16]])}))),function(){return t.apply(this,arguments)})},{key:"logout",value:function(){console.log("🚪 Logging out user"),sessionStorage.removeItem("access_token"),sessionStorage.removeItem("refresh_token"),sessionStorage.removeItem("token_expiry"),sessionStorage.removeItem("oauth_state"),sessionStorage.removeItem("user_id"),console.log("✅ Logout completed, all tokens and user ID removed")}},{key:"cancelAuth",value:function(){console.log("❌ Cancelling authentication process"),this.isCancelled=!0,this.pollInterval&&(console.log("🛑 Clearing polling interval"),clearInterval(this.pollInterval),this.pollInterval=null),this.authWindow&&!this.authWindow.closed&&(console.log("🪟 Closing auth window"),this.authWindow.close(),this.authWindow=null),this.authCompleted=!1,this.state=null,console.log("✅ Authentication cancellation completed")}},{key:"openCreditsDialog",value:(e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("🛒 Opening credits purchase dialog for user:",t),n="https://saifs.ai/canva_pricing/".concat(t,"/16"),console.log("🔗 Constructed credits URL:",n),e.abrupt("return",new Promise((function(e,t){Office.context.ui.displayDialogAsync(n,{height:80,width:80},(function(n){if(n.status===Office.AsyncResultStatus.Failed)return console.error("❌ Failed to open credits dialog:",n.error),void t(new Error("Failed to open credits dialog: ".concat(n.error.message)));var r=n.value;console.log("✅ Credits dialog opened successfully"),r.addEventHandler(Office.EventType.DialogEventReceived,(function(e){console.log("📬 Credits dialog event received:",e)})),r.addEventHandler(Office.EventType.DialogMessageReceived,(function(e){console.log("📬 Credits dialog message received:",e)})),r.addEventHandler(Office.EventType.DialogClosed,(function(t){console.log("🚪 Credits dialog closed:",t),e({success:!0})})),r.displayAsync()}))})));case 4:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})}]);var e,t,n,r,o,a,i}();window.OfficeAuthManager=OfficeAuthManager;